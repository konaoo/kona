{% extends "base.html" %}

{% set active_page = "news" %}

{% block styles %}
    .news-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .news-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
    }

    .live-status {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--red);
        font-weight: 600;
        font-size: 14px;
        background: rgba(239, 68, 68, 0.1);
        padding: 6px 12px;
        border-radius: 20px;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 800;
        background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.5px;
    }
    
    .news-timeline {
        position: relative;
        padding-left: 20px;
        border-left: 2px solid var(--border);
    }
    
    .news-item {
        position: relative;
        margin-bottom: 24px;
        padding-left: 20px;
        /* 初始状态用于动画 */
        opacity: 0;
        transform: translateY(-20px);
        max-height: 0;
        margin-bottom: 0;
        overflow: hidden;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* 动画激活状态 */
    .news-item.show {
        opacity: 1;
        transform: translateY(0);
        max-height: 500px; /* 足够大的高度 */
        margin-bottom: 24px;
        padding-top: 10px; /* 稍微给点间距 */
    }
    
    .news-dot {
        position: absolute;
        left: -27px;
        top: 18px; /* 微调对齐时间 */
        width: 12px;
        height: 12px;
        background: var(--bg-tertiary);
        border: 2px solid var(--text-secondary);
        border-radius: 50%;
        transition: all 0.3s;
        z-index: 2;
    }
    
    .news-item.important .news-dot {
        background: var(--red);
        border-color: var(--red);
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    }
    
    .news-time {
        font-size: 14px;
        color: var(--text-secondary);
        font-family: 'JetBrains Mono', monospace;
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    .news-content {
        background: var(--bg-tertiary);
        padding: 18px;
        border-radius: 12px;
        border: 1px solid var(--border);
        line-height: 1.6;
        font-size: 16px;
        color: var(--text-primary);
        transition: all 0.2s;
        box-shadow: var(--shadow);
    }
    
    .news-item:hover .news-content {
        background: var(--bg-secondary);
        border-color: var(--accent);
        transform: translateX(4px);
    }
    
    .news-item.important .news-content {
        border-left: 4px solid var(--red);
        background: linear-gradient(90deg, rgba(239, 68, 68, 0.05), transparent);
    }
    
    .live-dot {
        width: 8px;
        height: 8px;
        background: var(--red);
        border-radius: 50%;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
        font-style: italic;
    }
{% endblock %}

{% block content %}
    <div class="news-container">
        <div class="news-header">
            <h1 class="page-title">市场快讯</h1>
            <div class="live-status">
                <div class="live-dot"></div>
                LIVE
            </div>
        </div>
        
        <div id="timeline" class="news-timeline">
            <div class="loading" id="loadingMsg">正在接入全球市场数据...</div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    let lastId = null;
    let isFirstLoad = true;
    
    async function fetchNews() {
        try {
            const res = await fetch('/api/news/latest');
            const data = await res.json();
            
            if (!data || data.length === 0) return;
            
            const loading = document.getElementById('loadingMsg');
            if (loading) loading.style.display = 'none';
            
            // 首次加载
            if (isFirstLoad) {
                // 清空容器
                document.getElementById('timeline').innerHTML = '';
                
                // data 是 [最新 -> 最旧]
                // 我们要按此顺序展示，所以直接遍历 append 即可
                // 或者用 prepend 但要倒序遍历
                
                // 这里采用：按时间顺序从旧到新 prepend，这样最新的最后被插到顶部
                // data: [10:05, 10:00, 09:55]
                // reverse: [09:55, 10:00, 10:05]
                // loop:
                // 1. prepend 09:55 -> [09:55]
                // 2. prepend 10:00 -> [10:00, 09:55]
                // 3. prepend 10:05 -> [10:05, 10:00, 09:55]  <-- 正确顺序！
                
                const reversedData = [...data].reverse();
                reversedData.forEach(item => {
                    prependNews(item, false); // 首次加载不播放动画，直接显示
                });
                
                if (data.length > 0) lastId = data[0].id; // data[0] 是最新的
                isFirstLoad = false;
                return;
            }
            
            // 增量更新
            // 找出比 lastId 新的数据
            const newItems = [];
            for (let item of data) {
                // 注意：这里 ID 比较可能需要转 string，保险起见
                if (String(item.id) === String(lastId)) break;
                newItems.push(item);
            }
            
            if (newItems.length > 0) {
                // newItems 是 [最新, 次新...]
                // 同样倒序插入：[次新, 最新]
                // 1. prepend 次新
                // 2. prepend 最新 -> 最新在顶上
                
                [...newItems].reverse().forEach(item => {
                    prependNews(item, true); // 启用动画
                });
                
                lastId = newItems[0].id;
            }
            
        } catch (e) {
            console.error("News fetch failed:", e);
        }
    }
    
    function prependNews(item, animate) {
        const div = document.createElement('div');
        div.className = `news-item ${item.important ? 'important' : ''}`;
        div.innerHTML = `
            <div class="news-dot"></div>
            <div class="news-time">${item.time}</div>
            <div class="news-content">${item.content}</div>
        `;
        
        const timeline = document.getElementById('timeline');
        timeline.insertBefore(div, timeline.firstChild);
        
        // 动画逻辑
        if (animate) {
            // 强制重绘，确保 transition 生效
            div.offsetHeight; 
            div.classList.add('show');
        } else {
            // 首次加载直接添加类，无动画
            div.classList.add('show');
        }
        
        // 限制列表长度
        if (timeline.children.length > 100) {
            timeline.removeChild(timeline.lastChild);
        }
    }
    
    // 启动轮询 (每10秒)
    fetchNews();
    setInterval(fetchNews, 10000);
</script>
{% endblock %}
