<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Portfolio v10.4 - Cache Busted</title>
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="version" content="v10.4">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js?v=10.5"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: rgba(255, 255, 255, 0.05);
            --bg-tertiary: rgba(255, 255, 255, 0.08);
            --bg-sidebar: rgba(255, 255, 255, 0.02);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --blue: #3b82f6;
            --green: #00d26a;
            --red: #ff4d4f;
            --orange: #faad14;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.4);
            --radius: 16px;
            --radius-sm: 12px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
        }
        
        .sidebar {
            width: 240px;
            background: var(--bg-sidebar);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }
        
        .logo {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .menu-item {
            padding: 14px 18px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .menu-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateX(4px);
        }
        
        .menu-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            color: var(--text-primary);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 28px;
            max-width: 1500px;
        }
        
         .fab-group {
             position: fixed;
             top: 28px;
             right: 28px;
             z-index: 5000;
             display: flex;
             flex-direction: row-reverse;
             gap: 12px;
         }
        
        .fab-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            font-size: 22px;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }
        
        .fab-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-hover);
            background: var(--bg-tertiary);
        }
        
        .section {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            box-shadow: var(--shadow-hover);
        }
        
        .index-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
         .idx-card {
             background: var(--bg-tertiary);
             backdrop-filter: blur(10px);
             border-radius: var(--radius-sm);
             padding: 20px;
             transition: all 0.3s ease;
             display: flex;
             flex-direction: column;
         }
        
        .idx-card:hover {
            background: var(--bg-secondary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }
        
        .idx-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            height: 34px;
        }
        
        .idx-name {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            flex: 1;
        }
        
        .idx-chart {
            width: 80px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .idx-value {
            font-size: 30px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }
        
        .idx-change {
            font-size: 14px;
            font-weight: 500;
        }
        
        .idx-change.up {
            color: var(--red);
        }
        
        .idx-change.down {
            color: var(--green);
        }
        
        .assets-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 28px;
            gap: 28px;
        }
        
        .total-assets-section {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        .total-mv-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 14px;
            font-weight: 500;
        }
        
        .main-mv {
            font-size: 52px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-variant-numeric: tabular-nums;
        }
        
        .pnl-stats {
            display: flex;
            gap: 18px;
            flex: 1;
            justify-content: flex-end;
        }
        
         .pnl-stat-item {
             background: var(--bg-tertiary);
             backdrop-filter: blur(10px);
             border-radius: var(--radius-sm);
             padding: 18px 24px;
             min-width: 180px;
             text-align: left;
             transition: all 0.3s ease;
         }
        
        .pnl-stat-item:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }
        
        .pnl-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .pnl-value {
            font-size: 22px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin-bottom: 4px;
        }
        
        .pnl-rate {
            font-size: 13px;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }
        
        .pnl-value.up, .pnl-rate.up {
            color: var(--red);
        }
        
        .pnl-value.down, .pnl-rate.down {
            color: var(--green);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid var(--border);
        }
        
        .table-header h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 4px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .tab-item {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .tab-item:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-item.active {
            color: var(--text-primary);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: none;
            letter-spacing: 0;
            padding: 16px 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 16px 14px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }
        
        tr:hover td {
            background: var(--bg-tertiary);
        }
        
        .code-cell {
            font-weight: 600;
            color: var(--blue);
        }
        
        .price-cell {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .price-value {
            font-variant-numeric: tabular-nums;
        }
        
        .pnl-cell {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 3px;
        }
        
        .pnl-value {
            font-variant-numeric: tabular-nums;
        }
        
        .pnl-rate {
            font-size: 12px;
            font-variant-numeric: tabular-nums;
        }
        
        .pnl-cell.up .pnl-value,
        .pnl-cell.up .pnl-rate {
            color: var(--red);
        }
        
        .pnl-cell.down .pnl-value,
        .pnl-cell.down .pnl-rate {
            color: var(--green);
        }
        
        .editable {
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            padding: 2px 4px;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        
        .editable:hover {
            background: var(--bg-tertiary);
        }
        
        .inline-input {
            width: 100%;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--blue);
            border-radius: 8px;
            font-size: 14px;
            padding: 10px 14px;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            padding: 12px 28px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin: 0 2px;
            color: var(--text-primary);
        }
        
        .action-btn:hover {
            background: var(--bg-tertiary);
            transform: scale(1.1);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 6000;
        }
        
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px;
            width: 420px;
            box-shadow: var(--shadow-hover);
            border: 1px solid var(--border);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }
        
        .modal h3 {
            font-size: 22px;
            font-weight: 700;
        }
        
        .close-btn {
            cursor: pointer;
            font-size: 28px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .modal-input {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            box-sizing: border-box;
            margin-bottom: 18px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-group {
            margin-bottom: 18px;
        }
        
        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        #suggest {
            position: absolute;
            width: 100%;
            background: #1a1f3a;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-sm);
            display: none;
            z-index: 9999;
            max-height: 280px;
            overflow: auto;
            box-shadow: var(--shadow-hover);
            margin-top: 4px;
        }
        
        .suggest-item {
            padding: 12px 18px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            transition: background 0.2s ease;
        }
        
        .suggest-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .suggest-name {
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
            color: #ffffff;
        }
        
        .suggest-info {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .tag {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            font-weight: 500;
        }
        
        .suggest-code {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            .main-content {
                margin-left: 200px;
            }
            .assets-header {
                flex-direction: column;
            }
            .pnl-stats {
                padding-top: 24px;
                justify-content: center;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
                padding: 12px;
            }
            .sidebar .logo,
            .sidebar .menu-item span {
                display: none;
            }
            .main-content {
                margin-left: 60px;
                padding: 14px;
            }
            .index-grid {
                grid-template-columns: 1fr;
            }
            .pnl-stats {
                flex-direction: column;
                gap: 14px;
            }
            .pnl-stat-item {
                min-width: auto;
                width: 100%;
            }
            .main-mv {
                font-size: 38px;
            }
            .section {
                padding: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <span>üìä</span>
            <span>Portfolio</span>
        </div>
        <div class="menu-item active">
            <span>üíº</span>
            <span>ÊàëÁöÑÊäïËµÑ</span>
        </div>
        <div class="menu-item" onclick="alert('ÂäüËÉΩÂºÄÂèë‰∏≠')">
            <span>üìà</span>
            <span>Â∏ÇÂú∫ÂàÜÊûê</span>
        </div>
        <div class="menu-item" onclick="alert('ÂäüËÉΩÂºÄÂèë‰∏≠')">
            <span>üì∞</span>
            <span>ËµÑËÆØ</span>
        </div>
        <div class="menu-item" onclick="alert('ÂäüËÉΩÂºÄÂèë‰∏≠')">
            <span>‚öôÔ∏è</span>
            <span>ËÆæÁΩÆ</span>
        </div>
    </div>
     
     <div class="main-content" id="capture-area">
         <div class="fab-group" data-html2canvas-ignore="true">
             <button class="fab-btn" onclick="forceReload()">üîÑ</button>
             <button class="fab-btn" onclick="saveAsImage()">üì∏</button>
         </div>
         
         <div class="section">
            <div class="index-grid">
                <div class="idx-card" id="card-sh000001">
                    <div class="idx-header">
                        <div class="idx-name">‰∏äËØÅÊåáÊï∞</div>
                        <canvas class="idx-chart" id="chart-sh000001"></canvas>
                    </div>
                    <div class="idx-value" id="val-sh000001">--</div>
                    <div class="idx-change" id="chg-sh000001">--</div>
                </div>
                <div class="idx-card" id="card-hstech">
                    <div class="idx-header">
                        <div class="idx-name">ÊÅíÁîüÁßëÊäÄ</div>
                        <canvas class="idx-chart" id="chart-hstech"></canvas>
                    </div>
                    <div class="idx-value" id="val-hstech">--</div>
                    <div class="idx-change" id="chg-hstech">--</div>
                </div>
                <div class="idx-card" id="card-nasdaq">
                    <div class="idx-header">
                        <div class="idx-name">Á∫≥ÊñØËææÂÖã</div>
                        <canvas class="idx-chart" id="chart-nasdaq"></canvas>
                    </div>
                    <div class="idx-value" id="val-nasdaq">--</div>
                    <div class="idx-change" id="chg-nasdaq">--</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="assets-header">
                <div class="total-assets-section">
                    <div style="text-align: left;">
                        <div class="total-mv-label">
                            ÊÄªÊåÅÊúâÂ∏ÇÂÄº (CNY) 
                            <span onclick="togglePrivacy()" id="eyeIcon" style="cursor: pointer; margin-left: 8px;">üëÅÔ∏è</span>
                        </div>
                        <div class="main-mv" id="totalMV">¬• 0</div>
                    </div>
                </div>
                <div class="pnl-stats">
                    <div class="pnl-stat-item">
                        <div class="pnl-label">‰ªäÊó•Áõà‰∫è</div>
                        <div class="pnl-value" id="todayPnl">--</div>
                        <div class="pnl-rate" id="todayRate">--</div>
                    </div>
                    <div class="pnl-stat-item">
                        <div class="pnl-label">ÊåÅ‰ªìÁõà‰∫è</div>
                        <div class="pnl-value" id="floatPnl">--</div>
                        <div class="pnl-rate" id="floatRate">--</div>
                    </div>
                    <div class="pnl-stat-item">
                        <div class="pnl-label">Á¥ØËÆ°Áõà‰∫è</div>
                        <div class="pnl-value" id="totalPnl">--</div>
                        <div class="pnl-rate" id="totalRate">--</div>
                    </div>
                </div>
             </div>
         </div>
         
         <div class="section">
              <div class="table-header">
                  <h2>ÊåÅ‰ªìÊòéÁªÜ</h2>
                  <button class="btn-primary" onclick="openModal('add')">+ Ê∑ªÂä†ËµÑ‰∫ß</button>
              </div>
              <div class="category-tabs">
                  <div class="tab-item active" data-type="all" onclick="switchCategory('all')">ÂÖ®ÈÉ®</div>
                  <div class="tab-item" data-type="stock_cn" onclick="switchCategory('stock_cn')">AËÇ°</div>
                  <div class="tab-item" data-type="fund" onclick="switchCategory('fund')">Âü∫Èáë</div>
                  <div class="tab-item" data-type="stock_us" onclick="switchCategory('stock_us')">ÁæéËÇ°</div>
                  <div class="tab-item" data-type="stock_hk" onclick="switchCategory('stock_hk')">Ê∏ØËÇ°</div>
              </div>
              <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ËµÑ‰∫ß‰ª£Á†Å</th>
                            <th>ËµÑ‰∫ßÂêçÁß∞</th>
                            <th>ÊåÅÊúâÊï∞Èáè</th>
                            <th>ÊàêÊú¨/Áé∞‰ª∑</th>
                            <th>ÊåÅÊúâÈáëÈ¢ù</th>
                            <th>ÂΩìÊó•Áõà‰∫è</th>
                            <th>Á¥ØËÆ°Áõà‰∫è</th>
                            <th style="text-align: right;">Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="assetBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">--</h3>
                <button class="close-btn" onclick="document.getElementById('overlay').style.display='none'">&times;</button>
            </div>
            <div id="addForm">
                <div class="input-group">
                    <label class="input-label">ËµÑ‰∫ß‰ª£Á†Å</label>
                    <div style="position: relative;">
                        <input type="text" id="mCode" class="modal-input" placeholder="ËæìÂÖ•‰ª£Á†Å" autocomplete="off">
                        <div id="suggest"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">‰ª∑Ê†º</label>
                    <input type="number" id="mPrice" class="modal-input" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label class="input-label">Êï∞Èáè</label>
                    <input type="number" id="mQty" class="modal-input" placeholder="0">
                </div>
                <button class="btn-primary" onclick="saveAsset()" style="width: 100%;">Á°ÆËÆ§‰øùÂ≠ò</button>
            </div>
            <div id="tradeForm" style="display: none;">
                <input type="hidden" id="tCode">
                <p id="tNameDisplay" style="margin-bottom: 20px; color: var(--text-secondary); font-weight: 500;"></p>
                <div class="input-group">
                    <label class="input-label">Êàê‰∫§‰ª∑Ê†º</label>
                    <input type="number" id="tPrice" class="modal-input" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label class="input-label">‰∫§ÊòìÊï∞Èáè</label>
                    <input type="number" id="tQty" class="modal-input" placeholder="0">
                </div>
                <button id="tradeSubmitBtn" class="btn-primary" style="width: 100%;">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>
    
    <script>
        let FX = { USD: 7.25, HKD: 0.93, CNY: 1.00 };
        let isPrivacyMode = localStorage.getItem('privacy_mode') === 'true';
        let currentCategory = 'all';
        let portfolioData = {};
        let isFirstLoad = true;
        const syms = { USD: '$', HKD: 'HK$', CNY: '¬•' };

        function togglePrivacy() { 
            isPrivacyMode = !isPrivacyMode; 
            localStorage.setItem('privacy_mode', isPrivacyMode); 
            refreshAll(); 
        }
        
        // ÁªòÂà∂ÂæÆÂûãÊäòÁ∫øÂõæ
        function drawMiniChart(canvasId, change) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width = 80;
            const height = canvas.height = 30;

            // Ê∏ÖÈô§ÁîªÂ∏É
            ctx.clearRect(0, 0, width, height);

            // ÁîüÊàêÁ¨¶ÂêàË∂ãÂäøÁöÑÊ®°ÊãüÊï∞ÊçÆ
            const points = [];
            const pointCount = 30;
            const baseValue = 100;
            const isUp = change >= 0;
            const trendStrength = Math.min(Math.abs(change) / 2, 5);

            for (let i = 0; i < pointCount; i++) {
                const progress = i / (pointCount - 1);
                let value = baseValue;

                if (isUp) {
                    value += progress * change;
                    value += (Math.random() - 0.4) * trendStrength;
                } else {
                    value += progress * change;
                    value += (Math.random() - 0.6) * trendStrength;
                }

                points.push(value);
            }

            const color = change >= 0 ? '#ff4d4f' : '#00d26a';

            ctx.strokeStyle = color;
            ctx.lineWidth = 1.5;
            ctx.beginPath();

            const min = Math.min(...points);
            const max = Math.max(...points);
            const range = max - min || 1;

            points.forEach((point, i) => {
                const x = (i / (points.length - 1)) * width;
                const y = height - ((point - min) / range) * height * 0.8 - height * 0.1;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();
        }
        
        async function refreshAll() {
            const timestamp = Date.now();
            document.getElementById('eyeIcon').innerText = isPrivacyMode ? 'üôà' : 'üëÅÔ∏è';

            try { FX = await (await fetch(`/api/rates?t=${timestamp}`)).json(); } catch(e) {}

            const idxs = ['s_sh000001', 'rt_hkHSTECH', 'gb_ixic'];
            try {
                const idxPrices = await (await fetch(`/api/prices/batch?t=${timestamp}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({codes: idxs})
                })).json();
                
                const idxMap = {
                    's_sh000001': { id: 'sh000001', name: '‰∏äËØÅÊåáÊï∞' },
                    'rt_hkHSTECH': { id: 'hstech', name: 'ÊÅíÁîüÁßëÊäÄ' },
                    'gb_ixic': { id: 'nasdaq', name: 'Á∫≥ÊñØËææÂÖã' }
                };
                
                for (let code in idxPrices) {
                    const data = idxPrices[code];
                    const info = idxMap[code];
                    const el = document.getElementById(`val-${info.id}`);
                    const chgEl = document.getElementById(`chg-${info.id}`);
                    
                    if (el && data) {
                        const val = data.price > 0 ? data.price : data.yclose;
                        if (val > 0) {
                            el.innerText = val.toFixed(2);
                            const color = data.chg >= 0 ? 'up' : 'down';
                            chgEl.className = `idx-change ${color}`;
                            chgEl.innerText = `${data.chg >= 0 ? '+' : ''}${data.chg.toFixed(2)}%`;
                            drawMiniChart(`chart-${info.id}`, data.chg);
                        }
                    }
                }
            } catch (e) { }

            try {
                const apiUrl = currentCategory === 'all' ? '/api/portfolio' : `/api/portfolio?type=${currentCategory}`;
                const data = await (await fetch(`${apiUrl}?t=${timestamp}`)).json();

                let tMV = 0, tCost = 0, tDay = 0, gFloat = 0;
                const prices = data.length > 0 ? await (await fetch(`/api/prices/batch?t=${timestamp}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({codes: data.map(s => s.code)})
                })).json() : {};

                const newData = {};
                const newCodes = new Set();
                
                for (let s of data) {
                    const d = prices[s.code] || {price: 0, yclose: 0, chg: 0};
                    const qty = parseFloat(s.qty);
                    const cost = parseFloat(s.price);
                    const adj = parseFloat(s.adjustment) || 0;
                    
                    let curPrice = d.price > 0 ? d.price : (d.yclose > 0 ? d.yclose : cost);
                    const mv = curPrice * qty;
                    const ycloseRef = d.yclose || cost;
                    const day = (curPrice - ycloseRef) * qty;
                    const dayPnlRate = ycloseRef > 0 && d.chg === 0 ? ((curPrice - ycloseRef) / ycloseRef * 100) : (d.chg || 0);
                    const totPnl = (curPrice - cost) * qty + adj;
                    const rate = FX[s.curr] || 1;
                    const totPnlRate = cost * qty > 0 ? (totPnl / (cost * qty) * 100) : 0;

                    tMV += mv * rate;
                    tCost += cost * qty * rate;
                    tDay += day * rate;
                    gFloat += (mv - cost * qty) * rate;

                    newData[s.code] = {
                        s, d, qty, cost, adj, curPrice, mv, day,
                        dayPnlRate, totPnl, totPnlRate, rate
                    };
                    newCodes.add(s.code);
                }

                const oldCodes = new Set(Object.keys(portfolioData));
                const codesChanged = new Set([...newCodes].filter(c => !oldCodes.has(c)));
                const codesRemoved = new Set([...oldCodes].filter(c => !newCodes.has(c)));

                if (isFirstLoad || codesChanged.size > 0 || codesRemoved.size > 0) {
                    renderFullTable(newData);
                } else {
                    updateTableValues(newData);
                }

                portfolioData = newData;
                isFirstLoad = false;

                document.getElementById('totalMV').innerText = isPrivacyMode ? '****' : `¬• ${tMV.toLocaleString('zh-CN', {maximumFractionDigits: 0})}`;
                
                const updateStat = (id, val, base) => {
                    const el = document.getElementById(id);
                    const rateEl = document.getElementById(id.replace('Pnl', 'Rate'));
                    el.innerText = isPrivacyMode ? '****' : `¬• ${val.toLocaleString('zh-CN', {maximumFractionDigits: 0})}`;
                    el.className = 'pnl-value ' + (val >= 0 ? 'up' : 'down');
                    const rate = base > 0 ? (val / base * 100) : 0;
                    rateEl.innerText = `${rate >= 0 ? '+' : ''}${rate.toFixed(2)}%`;
                    rateEl.className = 'pnl-rate ' + (rate >= 0 ? 'up' : 'down');
                };
                
                updateStat('todayPnl', tDay, tMV);
                updateStat('floatPnl', gFloat, tCost);
                updateStat('totalPnl', gFloat, tCost);

            } catch (err) {
                console.error('Portfolio error:', err);
            }
        }

        function renderFullTable(dataMap) {
            const body = document.getElementById('assetBody');
            body.innerHTML = '';
            
            for (let code in dataMap) {
                const {s, qty, cost, curPrice, mv, day, dayPnlRate, totPnl, totPnlRate} = dataMap[code];
                const prec = (s.code.startsWith('f_') || s.code.startsWith('ft_')) ? 4 : 3;
                const displayCode = s.code.replace(/^(f_|ft_|gb_|sh|sz|hk|bj)/i, '');
                const dayPnlClass = day >= 0 ? 'up' : 'down';
                const totPnlClass = totPnl >= 0 ? 'up' : 'down';

                const priceCell = isPrivacyMode ? '--' : 
                    `<div class="price-cell">
                        <span class="price-value">${syms[s.curr] || ''}${cost.toFixed(prec)}</span>
                        <span class="price-value" style="font-size: 13px; color: var(--text-secondary);">${syms[s.curr] || ''}${curPrice.toFixed(prec)}</span>
                    </div>`;
                
                const dayPnlCell = isPrivacyMode ? '--' : 
                    `<div class="pnl-cell ${dayPnlClass}">
                        <span class="pnl-value">${syms[s.curr] || ''}${day.toFixed(2)}</span>
                        <span class="pnl-rate">${dayPnlRate >= 0 ? '+' : ''}${dayPnlRate.toFixed(2)}%</span>
                    </div>`;
                
                const totPnlCell = isPrivacyMode ? '--' : 
                    `<div class="pnl-cell ${totPnlClass}">
                        <span class="pnl-value">${syms[s.curr] || ''}${totPnl.toFixed(2)}</span>
                        <span class="pnl-rate">${totPnlRate >= 0 ? '+' : ''}${totPnlRate.toFixed(2)}%</span>
                    </div>`;

                const tr = document.createElement('tr');
                tr.id = `row-${s.code}`;
                tr.innerHTML = `
                    <td class="code-cell">${displayCode}</td>
                    <td style="font-weight: 500;">${s.name}</td>
                    <td>${qty.toLocaleString()}</td>
                    <td>${priceCell}</td>
                    <td>${syms[s.curr] || ''}${mv.toFixed(2)}</td>
                    <td>${dayPnlCell}</td>
                    <td>${totPnlCell}</td>
                    <td style="text-align: right;">
                        <button class="action-btn" onclick="openTradeModal('buy','${s.code}','${s.name}','${curPrice}')" title="Âä†‰ªì">‚ûï</button>
                        <button class="action-btn" onclick="openTradeModal('sell','${s.code}','${s.name}','${curPrice}')" title="Âáè‰ªì">‚ûñ</button>
                        <button class="action-btn" onclick="deleteStock('${s.code}')" title="Âà†Èô§">üóëÔ∏è</button>
                    </td>`;
                body.appendChild(tr);
            }
        }

        function updateTableValues(newDataMap) {
            for (let code in newDataMap) {
                const {s, qty, cost, curPrice, mv, day, dayPnlRate, totPnl, totPnlRate} = newDataMap[code];
                const tr = document.getElementById(`row-${code}`);
                if (!tr) continue;

                const prec = (s.code.startsWith('f_') || s.code.startsWith('ft_')) ? 4 : 3;
                const dayPnlClass = day >= 0 ? 'up' : 'down';
                const totPnlClass = totPnl >= 0 ? 'up' : 'down';

                const cells = tr.querySelectorAll('td');
                
                if (!isPrivacyMode) {
                    const priceCell = cells[3];
                    priceCell.innerHTML = `<div class="price-cell">
                        <span class="price-value">${syms[s.curr] || ''}${cost.toFixed(prec)}</span>
                        <span class="price-value" style="font-size: 13px; color: var(--text-secondary);">${syms[s.curr] || ''}${curPrice.toFixed(prec)}</span>
                    </div>`;
                    
                    cells[4].innerText = `${syms[s.curr] || ''}${mv.toFixed(2)}`;
                    cells[5].innerHTML = `<div class="pnl-cell ${dayPnlClass}">
                        <span class="pnl-value">${syms[s.curr] || ''}${day.toFixed(2)}</span>
                        <span class="pnl-rate">${dayPnlRate >= 0 ? '+' : ''}${dayPnlRate.toFixed(2)}%</span>
                    </div>`;
                    cells[6].innerHTML = `<div class="pnl-cell ${totPnlClass}">
                        <span class="pnl-value">${syms[s.curr] || ''}${totPnl.toFixed(2)}</span>
                        <span class="pnl-rate">${totPnlRate >= 0 ? '+' : ''}${totPnlRate.toFixed(2)}%</span>
                    </div>`;
                    
                    const btns = cells[7].querySelectorAll('.action-btn');
                    btns[0].onclick = () => openTradeModal('buy', s.code, s.name, curPrice);
                    btns[1].onclick = () => openTradeModal('sell', s.code, s.name, curPrice);
                }
            }
        }

        async function edit(el, field, code) {
            if (el.querySelector('input')) return;
            const val = el.innerText.replace(/[^0-9.-]/g, '');
            const inp = document.createElement('input');
            inp.className = 'inline-input';
            inp.type = 'number';
            inp.value = val;
            el.innerHTML = '';
            el.appendChild(inp);
            inp.focus();
            
            inp.onblur = async () => {
                let fVal = parseFloat(inp.value);
                let fF = field;
                
                if (field === 'pnl') {
                    const r = el.closest('tr');
                    const q = parseFloat(r.cells[2].innerText.replace(/,/g, ''));
                    const priceCells = r.cells[3].querySelectorAll('.price-value');
                    const c = parseFloat(priceCells[0]?.innerText.replace(/[^0-9.-]/g, '') || 0);
                    const p = parseFloat(priceCells[1]?.innerText.replace(/[^0-9.-]/g, '') || c);
                    fVal = fVal - ((p - c) * q);
                    fF = 'adjustment';
                }
                
                await fetch(`/api/portfolio/update?t=${Date.now()}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code, field: fF, val: fVal})
                });
                refreshAll();
            };
        }

        function openModal(type) { 
            document.getElementById('overlay').style.display = 'block'; 
            document.getElementById('addForm').style.display = 'block'; 
            document.getElementById('tradeForm').style.display = 'none'; 
            document.getElementById('modalTitle').innerText = 'Ê∑ªÂä†ËµÑ‰∫ß'; 
            document.getElementById('mCode').value = ''; 
            document.getElementById('mPrice').value = ''; 
            document.getElementById('mQty').value = ''; 
            document.getElementById('suggest').style.display = 'none'; 
        }
        
        function openTradeModal(type, c, n, p) { 
            document.getElementById('overlay').style.display = 'block'; 
            document.getElementById('addForm').style.display = 'none'; 
            document.getElementById('tradeForm').style.display = 'block'; 
            document.getElementById('tCode').value = c; 
            document.getElementById('tNameDisplay').innerText = `${n} ${type === 'buy' ? 'Âä†‰ªì' : 'Âáè‰ªì'}`; 
            document.getElementById('tPrice').value = p; 
            document.getElementById('tQty').value = ''; 
            const btn = document.getElementById('tradeSubmitBtn'); 
            btn.innerText = type === 'buy' ? 'Á°ÆËÆ§Âä†‰ªì' : 'Á°ÆËÆ§ÂçñÂá∫'; 
            btn.style.background = type === 'buy' ? 'var(--red)' : 'var(--green)';
            btn.onclick = () => confirmTrade(type); 
        }
        
        async function saveAsset() {
            let code = document.getElementById('mCode').value.trim();
            const price = document.getElementById('mPrice').value;
            const qty = document.getElementById('mQty').value;
            
            if (/^\d+$/.test(code)) {
                if (code.startsWith('11')) code = 'f_' + code;
                else if (code.startsWith('6') || code.startsWith('5') || code.startsWith('9')) code = 'sh' + code;
                else if (code.startsWith('0') || code.startsWith('3') || code.startsWith('1') || code.startsWith('2')) code = 'sz' + code;
                else if (code.startsWith('4') || code.startsWith('8')) code = 'bj' + code;
            } else if (code.toUpperCase().endsWith('.HK')) {
                code = 'hk' + code.toUpperCase().replace('.HK', '');
            } else if (/^[a-zA-Z]+$/.test(code)) {
                code = 'gb_' + code.toLowerCase();
            }

            let curr = 'CNY'; 
            if (code.startsWith('gb_') || code.startsWith('ft_')) curr = 'USD';
            if (code.startsWith('hk')) curr = 'HKD';
            
            await fetch(`/api/portfolio/add?t=${Date.now()}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code, name: code, qty, price, curr, adjustment: 0})
            });
            document.getElementById('overlay').style.display = 'none'; 
            refreshAll();
        }

        async function confirmTrade(type) { 
            const code = document.getElementById('tCode').value;
            const price = document.getElementById('tPrice').value;
            const qty = document.getElementById('tQty').value;
            await fetch(`/api/portfolio/${type}?t=${Date.now()}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code, price, qty})
            }); 
            document.getElementById('overlay').style.display = 'none'; 
            refreshAll(); 
        }
        
        async function deleteStock(code) { 
            if (confirm("Á°ÆÂÆöÂà†Èô§Ê≠§ËµÑ‰∫ßÔºü")) {
                await fetch(`/api/portfolio/delete?t=${Date.now()}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code})
                }); 
                refreshAll(); 
            } 
        }
        
        let searchTimeout;
        document.getElementById('mCode').addEventListener('input', (e) => { 
            clearTimeout(searchTimeout);
            const v = e.target.value.trim(); 
            const box = document.getElementById('suggest'); 
            if (v.length < 1) { 
                box.style.display = 'none'; 
                return; 
            }
            searchTimeout = setTimeout(async () => {
                const r = await fetch(`/api/search?q=${encodeURIComponent(v)}&t=${Date.now()}`);
                const list = await r.json(); 
                if (list.length > 0) {
                    box.innerHTML = list.map(s => {
                        let typeIcon = '‚ùì';
                        let typeColor = '#666';
                        const code = s.code.toLowerCase();

                        if (code.startsWith('sh') || code.startsWith('sz') || code.startsWith('bj')) {
                            typeIcon = 'üá®üá≥ AËÇ°';
                            typeColor = '#3b82f6';
                        } else if (code.startsWith('hk')) {
                            typeIcon = 'üá≠üá∞ Ê∏ØËÇ°';
                            typeColor = '#f59e0b';
                        } else if (code.startsWith('gb_')) {
                            typeIcon = 'üá∫üá∏ ÁæéËÇ°';
                            typeColor = '#8b5cf6';
                        } else if (code.startsWith('f_') || code.startsWith('ft_')) {
                            typeIcon = 'üìä Âü∫Èáë';
                            typeColor = '#10b981';
                        }

                        return `<div class="suggest-item" onclick="pick('${s.code}','${s.name}','${s.currency}')">
                            <span class="suggest-name">${s.name}</span>
                            <div class="suggest-info">
                                <span class="tag" style="background: ${typeColor}20; color: ${typeColor};">${typeIcon}</span>
                                <span class="suggest-code">${s.code}</span>
                            </div>
                        </div>`;
                    }).join('');
                    box.style.display = 'block';
                } else {
                    box.style.display = 'none';
                }
            }, 300);
        });

        function pick(c, n, cur) {
            document.getElementById('mCode').value = n;
            document.getElementById('suggest').style.display = 'none';
        }
        
        function saveAsImage() {
            html2canvas(document.querySelector('#capture-area'), {
                backgroundColor: '#0a0e27',
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'portfolio.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function switchCategory(type) {
            console.log('ÂàáÊç¢ÂàÜÁ±ª:', type);
            console.log('ÂΩìÂâçportfolioData keys:', Object.keys(portfolioData));
            currentCategory = type;

            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.type === type) {
                    tab.classList.add('active');
                }
            });

            portfolioData = {};
            isFirstLoad = false;
            refreshAll();
        }

        setInterval(refreshAll, 60000);

        window.onload = () => {
            refreshAll();
        };

        // Ê∑ªÂä†ÂÖ®Â±ÄÁºìÂ≠òÁ†¥ÂùèÂáΩÊï∞
         function fetchWithCache(url, options = {}) {
            if (!url.includes('?')) {
                url += '?';
            } else {
                url += '&';
            }
            url += `t=${Date.now()}`;
            return fetch(url, options);
        }
</script>
</body>
</html>
