{% extends "base.html" %}

{% set active_page = "settings" %}

{% block styles %}
    .settings-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .settings-header {
        margin-bottom: 30px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 20px;
    }

    .page-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* å¡ç‰‡å¸ƒå±€ */
    .settings-card {
        background: var(--bg-secondary);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 24px;
        margin-bottom: 24px;
    }

    .card-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-desc {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 20px;
        line-height: 1.5;
    }

    /* æŒ‰é’®ç»„ */
    .action-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn:hover {
        background: var(--bg-secondary);
        border-color: var(--accent);
        transform: translateY(-1px);
    }

    .btn-primary {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
    }
    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-danger {
        color: var(--red);
        border-color: rgba(239, 68, 68, 0.3);
    }
    .btn-danger:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--red);
    }

    /* API çŠ¶æ€åˆ—è¡¨ */
    .api-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .api-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        border: 1px solid var(--border);
    }

    .api-info { display: flex; flex-direction: column; gap: 4px; }
    .api-name { font-weight: 600; font-size: 14px; }
    .api-url { font-size: 12px; color: var(--text-secondary); font-family: monospace; }

    .api-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        background: #334155;
        color: #94a3b8;
    }
    .api-status.ok { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .api-status.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    /* ç‰ˆæœ¬ä¿¡æ¯ */
    .version-info {
        background: var(--bg-primary);
        padding: 16px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 16px;
    }

    .commit-hash { color: var(--accent); }
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-header">
        <h1 class="page-title">ç³»ç»Ÿè®¾ç½®</h1>
    </div>

    <!-- æ•°æ®ç®¡ç† -->
    <div class="settings-card">
        <div class="card-title">ğŸ’¾ æ•°æ®ç®¡ç†</div>
        <div class="card-desc">
            æ‚¨çš„æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°æ•°æ®åº“ä¸­ã€‚å»ºè®®å®šæœŸå¤‡ä»½ï¼Œä»¥é˜²æ•°æ®ä¸¢å¤±ã€‚<br>
            æ¢å¤æ•°æ®å°†è¦†ç›–å½“å‰çš„æ‰€æœ‰è®°å½•ï¼Œè¯·è°¨æ…æ“ä½œã€‚
        </div>
        <div class="action-group">
            <a href="/api/settings/backup" target="_blank" class="btn btn-primary">
                <span>â¬‡ï¸</span> ä¸‹è½½å¤‡ä»½ (.db)
            </a>
            <button class="btn" onclick="document.getElementById('fileInput').click()">
                <span>â¬†ï¸</span> æ¢å¤æ•°æ®
            </button>
            <input type="file" id="fileInput" accept=".db" style="display: none" onchange="restoreData(this)">
        </div>
    </div>

    <!-- API æºæ£€æµ‹ -->
    <div class="settings-card">
        <div class="card-title">ğŸŒ API æ¥å£æ£€æµ‹</div>
        <div class="card-desc">
            æ£€æµ‹å½“å‰ä½¿ç”¨çš„æ•°æ®æºè¿é€šæ€§ã€‚å¦‚æœè¡Œæƒ…æˆ–å¿«è®¯æ— æ³•åŠ è½½ï¼Œè¯·åœ¨æ­¤æ£€æŸ¥æ¥å£çŠ¶æ€ã€‚
        </div>
        <div class="api-list" id="apiList">
            <div class="api-item">
                <div class="api-info">
                    <span class="api-name">è‚¡ä»·æ¥å£ (Sina/Tencent)</span>
                    <span class="api-url">hq.sinajs.cn</span>
                </div>
                <span class="api-status" id="status-price">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="api-item">
                <div class="api-info">
                    <span class="api-name">æ±‡ç‡æ¥å£</span>
                    <span class="api-url">hq.sinajs.cn (Forex)</span>
                </div>
                <span class="api-status" id="status-rate">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="api-item">
                <div class="api-info">
                    <span class="api-name">å¿«è®¯æ¥å£ (Sina)</span>
                    <span class="api-url">zhibo.sina.com.cn</span>
                </div>
                <span class="api-status" id="status-news">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
        <div class="action-group" style="margin-top: 16px;">
            <button class="btn" onclick="checkApiStatus()">ğŸ”„ é‡æ–°æ£€æµ‹</button>
        </div>
    </div>

    <!-- å…³äºç³»ç»Ÿ -->
    <div class="settings-card">
        <div class="card-title">â„¹ï¸ å…³äºç³»ç»Ÿ</div>
        <div class="version-info">
            <div>ç‰ˆæœ¬: <span id="appVersion">Loading...</span></div>
            <div>Git Commit: <span id="gitCommit" class="commit-hash">Loading...</span></div>
            <div>æœ€åæ›´æ–°: <span id="lastUpdate">Loading...</span></div>
        </div>
        <div class="card-desc">
            å¦‚éœ€æ›´æ–°æˆ–å›é€€ç‰ˆæœ¬ï¼Œè¯·åœ¨ç»ˆç«¯ä½¿ç”¨ git å‘½ä»¤æ“ä½œã€‚<br>
            æ¨èå‘½ä»¤: git pull (æ›´æ–°), git checkout [hash] (å›é€€)
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // æ¢å¤æ•°æ®
    async function restoreData(input) {
        if (!input.files || input.files.length === 0) return;
        
        const file = input.files[0];
        if (!confirm(`ç¡®å®šè¦ä»å¤‡ä»½æ–‡ä»¶ "${file.name}" æ¢å¤æ•°æ®å—ï¼Ÿ\nå½“å‰æ‰€æœ‰æ•°æ®å°†è¢«è¦†ç›–ä¸”æ— æ³•æ’¤é”€ï¼`)) {
            input.value = '';
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch('/api/settings/restore', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (res.ok) {
                alert('æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚');
                window.location.reload();
            } else {
                alert('æ¢å¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (e) {
            console.error(e);
            alert('ä¸Šä¼ å¤±è´¥');
        }
        input.value = '';
    }

    // æ£€æŸ¥APIçŠ¶æ€
    async function checkApiStatus() {
        const endpoints = ['price', 'rate', 'news'];
        
        endpoints.forEach(ep => {
            const el = document.getElementById(`status-${ep}`);
            el.className = 'api-status';
            el.innerText = 'æ£€æµ‹ä¸­...';
        });

        try {
            const res = await fetch('/api/settings/check_api');
            const data = await res.json();
            
            Object.keys(data).forEach(key => {
                // key: price, rate, news
                const info = data[key]; // {ok: true, latency: 120}
                const el = document.getElementById(`status-${key}`);
                
                if (info.ok) {
                    el.className = 'api-status ok';
                    el.innerText = `æ­£å¸¸ (${info.latency}ms)`;
                } else {
                    el.className = 'api-status error';
                    el.innerText = `å¼‚å¸¸: ${info.error || 'Timeout'}`;
                }
            });
        } catch (e) {
            console.error('Check failed', e);
        }
    }

    // è·å–ç³»ç»Ÿä¿¡æ¯
    async function loadSystemInfo() {
        try {
            const res = await fetch('/api/settings/info');
            const data = await res.json();
            
            document.getElementById('appVersion').innerText = data.version;
            document.getElementById('gitCommit').innerText = data.commit_hash;
            document.getElementById('lastUpdate').innerText = data.last_update;
        } catch (e) {
            console.error('Info load failed', e);
        }
    }

    // åˆå§‹åŒ–
    window.onload = () => {
        loadSystemInfo();
        checkApiStatus();
    };
</script>
{% endblock %}
