{% extends "base.html" %}

{% set active_page = "investment" %}

{% block styles %}
    .index-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }
    
    .idx-card {
        background: var(--bg-tertiary);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-sm);
        padding: 20px;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        border: 2px solid var(--border);
        position: relative;
        overflow: hidden;
        min-height: 120px;
    }
    
    .idx-card .idx-chart-bg {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        opacity: 0.3;
    }
    
    .idx-card:hover {
        background: var(--bg-secondary);
        transform: translateY(-4px);
        box-shadow: var(--shadow-hover);
    }
    
    .idx-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
        z-index: 2;
    }
    
    .idx-name {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }
    
    .idx-content {
        position: relative;
        z-index: 2;
    }
    
    .idx-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
        font-variant-numeric: tabular-nums;
    }
    
    .idx-change {
        font-size: 14px;
        font-weight: 600;
    }
    
    .idx-change.up { color: var(--red); }
    .idx-change.down { color: var(--green); }
    
    .assets-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 28px;
        gap: 28px;
    }
    
    .total-assets-section {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
    }
    
    .total-mv-label {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 14px;
        font-weight: 500;
    }
    
    .main-mv {
        font-size: 52px;
        font-weight: 700;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-variant-numeric: tabular-nums;
        user-select: none;
    }
    
    .pnl-stats {
        display: flex;
        gap: 18px;
        flex: 1;
        justify-content: flex-end;
    }
    
    .pnl-stat-item {
        background: var(--bg-tertiary);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-sm);
        padding: 18px 24px;
        min-width: 180px;
        text-align: left;
        transition: all 0.3s ease;
        border: 2px solid var(--border);
    }
    
    .pnl-stat-item:hover {
        background: var(--bg-secondary);
        transform: translateY(-2px);
    }
    
    .pnl-label {
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 500;
        margin-bottom: 8px;
    }
    
    .pnl-value {
        font-size: 22px;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        margin-bottom: 4px;
        font-size: 15px;
        font-weight: 600;
    }
    
    .pnl-rate {
        font-size: 13px;
        font-weight: 500;
        font-variant-numeric: tabular-nums;
        opacity: 0.9;
    }
    
    .pnl-value.up, .pnl-rate.up { color: var(--red); }
    .pnl-value.down, .pnl-rate.down { color: var(--green); }
    
    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
        padding-bottom: 18px;
        border-bottom: 1px solid var(--border);
    }
    
    .table-header h2 {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .category-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        padding: 4px;
        background: var(--bg-tertiary);
        border-radius: 12px;
        border: 1px solid var(--border);
    }

    .tab-item {
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.3s ease;
        white-space: nowrap;
        position: relative;
    }

    .tab-item:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.05);
    }

    .tab-item.active {
        color: var(--text-primary);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .table-container { overflow-x: auto; }
    
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    th {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: none;
        letter-spacing: 0;
        padding: 16px 14px;
        text-align: left;
        border-bottom: 1px solid var(--border);
        background: var(--bg-tertiary);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    td {
        padding: 16px 14px;
        border-bottom: 1px solid var(--border);
        transition: background 0.2s ease;
    }
    
    tr:hover td { background: var(--bg-tertiary); }
    
    .code-cell { font-weight: 600; color: var(--accent); }
    
    .price-cell {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }
    
    .price-value { font-variant-numeric: tabular-nums; }

    .name-cell {
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }
    
    .pnl-cell {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 3px;
    }
    
    .pnl-cell.up .pnl-value, .pnl-cell.up .pnl-rate { color: var(--red); }
    .pnl-cell.down .pnl-value, .pnl-cell.down .pnl-rate { color: var(--green); }
    
    .editable {
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        padding: 2px 4px;
        transition: all 0.2s ease;
        border-radius: 4px;
    }
    
    .editable:hover { background: var(--bg-tertiary); }
    
    .inline-input {
        width: 100%;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--accent);
        border-radius: 8px;
        font-size: 14px;
        padding: 10px 14px;
        font-family: inherit;
    }
    
    .action-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 18px;
        padding: 6px 10px;
        border-radius: 8px;
        transition: all 0.2s ease;
        margin: 0 2px;
        color: var(--text-primary);
    }
    
    .action-btn:hover {
        background: var(--bg-tertiary);
        transform: scale(1.1);
    }
    
    /* ä¸‹æ‹‰èœå•æ ·å¼ */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background-color: var(--bg-secondary);
        min-width: 140px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        z-index: 100;
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: hidden;
        margin-top: 4px;
        padding: 4px;
    }

    .dropdown-content button {
        color: var(--text-primary);
        padding: 10px 12px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        border-radius: 8px;
    }

    .dropdown-content button:hover { background-color: var(--bg-tertiary); }

    .dropdown-content button.delete-btn { color: #ef4444; }
    
    .dropdown-content button.delete-btn:hover { background-color: rgba(239, 68, 68, 0.1); }
    
    .show { display: block; }
    
    .more-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 20px;
        line-height: 1;
        transition: all 0.2s;
    }
    
    .more-btn:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }
    
    .section {
        background: var(--bg-secondary);
        backdrop-filter: blur(20px);
        border-radius: var(--radius);
        padding: 28px;
        margin-bottom: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        transition: all 0.3s ease;
    }
    
    .section:hover { box-shadow: var(--shadow-hover); }
    
    /* æœç´¢å»ºè®®æ¡† */
    #suggest {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        z-index: 9999;
        max-height: 300px;
        overflow-y: auto;
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .suggest-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .suggest-item:hover { background: var(--bg-tertiary); }
    .suggest-name { font-weight: 500; color: var(--text-primary); }
    .suggest-info { font-size: 12px; display: flex; align-items: center; gap: 8px; }
    .suggest-code { color: var(--text-secondary); font-family: monospace; }
    .tag {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }
{% endblock %}

{% block fab_buttons %}
    <button class="fab-btn" onclick="forceReload()">ğŸ”„</button>
{% endblock %}

{% block content %}
    <div class="section">
        <div class="index-grid">
            <div class="idx-card" id="card-sh000001">
                <div class="idx-header">
                    <div class="idx-name">ä¸Šè¯æŒ‡æ•°</div>
                </div>
                <div class="idx-content">
                    <div class="idx-value" id="val-sh000001">--</div>
                    <div class="idx-change" id="chg-sh000001">--</div>
                </div>
                <canvas class="idx-chart-bg" id="chart-sh000001"></canvas>
            </div>
            <div class="idx-card" id="card-hstech">
                <div class="idx-header">
                    <div class="idx-name">æ’ç”Ÿç§‘æŠ€</div>
                </div>
                <div class="idx-content">
                    <div class="idx-value" id="val-hstech">--</div>
                    <div class="idx-change" id="chg-hstech">--</div>
                </div>
                <canvas class="idx-chart-bg" id="chart-hstech"></canvas>
            </div>
            <div class="idx-card" id="card-nasdaq">
                <div class="idx-header">
                    <div class="idx-name">çº³æ–¯è¾¾å…‹</div>
                </div>
                <div class="idx-content">
                    <div class="idx-value" id="val-nasdaq">--</div>
                    <div class="idx-change" id="chg-nasdaq">--</div>
                </div>
                <canvas class="idx-chart-bg" id="chart-nasdaq"></canvas>
            </div>
        </div>
    </div>
    
    <div class="section">
        <div class="assets-header">
            <div class="total-assets-section">
                <div style="text-align: left;">
                    <div class="total-mv-label">
                        æ€»æŒæœ‰å¸‚å€¼ (CNY) 
                    </div>
                    <div class="main-mv" id="totalMV">Â¥ 0</div>
                </div>
            </div>
            <div class="pnl-stats">
                <div class="pnl-stat-item">
                    <div class="pnl-label">ä»Šæ—¥ç›ˆäº</div>
                    <div class="pnl-value" id="todayPnl">--</div>
                    <div class="pnl-rate" id="todayRate">--</div>
                </div>
                <div class="pnl-stat-item">
                    <div class="pnl-label">æŒä»“ç›ˆäº</div>
                    <div class="pnl-value" id="floatPnl">--</div>
                    <div class="pnl-rate" id="floatRate">--</div>
                </div>
                <div class="pnl-stat-item">
                    <div class="pnl-label">ç´¯è®¡ç›ˆäº</div>
                    <div class="pnl-value" id="totalPnl">--</div>
                    <div class="pnl-rate" id="totalRate">--</div>
                </div>
            </div>
         </div>
     </div>
     
     <div class="section">
          <div class="table-header">
              <h2>æŒä»“æ˜ç»†</h2>
              <button class="btn-primary" onclick="openModal('add')">+ æ·»åŠ èµ„äº§</button>
          </div>
          <div class="category-tabs">
              <div class="tab-item active" data-type="all" onclick="switchCategory('all')">å…¨éƒ¨</div>
              <div class="tab-item" data-type="stock_cn" onclick="switchCategory('stock_cn')">Aè‚¡</div>
              <div class="tab-item" data-type="fund" onclick="switchCategory('fund')">åŸºé‡‘</div>
              <div class="tab-item" data-type="stock_us" onclick="switchCategory('stock_us')">ç¾è‚¡</div>
              <div class="tab-item" data-type="stock_hk" onclick="switchCategory('stock_hk')">æ¸¯è‚¡</div>
          </div>
          <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>èµ„äº§ä»£ç </th>
                        <th>èµ„äº§åç§°</th>
                        <th>æŒæœ‰æ•°é‡</th>
                        <th>æˆæœ¬/ç°ä»·</th>
                        <th>æŒæœ‰é‡‘é¢</th>
                        <th>å½“æ—¥ç›ˆäº</th>
                        <th>ç´¯è®¡ç›ˆäº</th>
                        <th style="text-align: right;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="assetBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="overlay" id="overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">--</h3>
            <button class="close-btn" onclick="document.getElementById('overlay').style.display='none'">&times;</button>
        </div>
        <div id="addForm">
            <div class="input-group">
                <label class="input-label">èµ„äº§ä»£ç </label>
                <div style="position: relative;">
                    <input type="text" id="mCode" class="modal-input" placeholder="è¾“å…¥ä»£ç " autocomplete="off">
                    <input type="hidden" id="mRealCode">
                    <input type="hidden" id="mCurrency">
                    <input type="hidden" id="mName">
                    <div id="suggest"></div>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">ä»·æ ¼</label>
                <input type="number" id="mPrice" class="modal-input" placeholder="0.00">
            </div>
            <div class="input-group">
                <label class="input-label">æ•°é‡</label>
                <input type="number" id="mQty" class="modal-input" placeholder="0">
            </div>
            <button class="btn-primary" onclick="saveAsset()" style="width: 100%;">ç¡®è®¤ä¿å­˜</button>
        </div>
        <div id="tradeForm" style="display: none;">
            <input type="hidden" id="tCode">
            <p id="tNameDisplay" style="margin-bottom: 20px; color: var(--text-secondary); font-weight: 500;"></p>
            <div class="input-group">
                <label class="input-label">æˆäº¤ä»·æ ¼</label>
                <input type="number" id="tPrice" class="modal-input" placeholder="0.00">
            </div>
            <div class="input-group">
                <label class="input-label">äº¤æ˜“æ•°é‡</label>
                <input type="number" id="tQty" class="modal-input" placeholder="0">
            </div>
            <button id="tradeSubmitBtn" class="btn-primary" style="width: 100%;">ç¡®è®¤</button>
        </div>
        <div id="editForm" style="display: none;">
            <input type="hidden" id="eCode">
            <p id="eNameDisplay" style="margin-bottom: 20px; color: var(--text-secondary); font-weight: 500;"></p>
            <div class="input-group">
                <label class="input-label">æŒä»“æ•°é‡</label>
                <input type="number" id="eQty" class="modal-input" placeholder="0">
                <div class="help-text" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ä¿®æ­£å½“å‰æŒæœ‰çš„å®é™…è‚¡æ•°</div>
            </div>
            <div class="input-group">
                <label class="input-label">å¹³å‡æˆæœ¬</label>
                <input type="number" id="ePrice" class="modal-input" placeholder="0.00">
                <div class="help-text" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ä¿®æ­£æŒä»“å¹³å‡æˆæœ¬å•ä»·</div>
            </div>
            <div class="input-group">
                <label class="input-label">ç´¯è®¡ç›ˆäºæ ¡å‡† (è°ƒæ•´å€¼)</label>
                <input type="number" id="eAdj" class="modal-input" placeholder="0.00">
                <div class="help-text" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ç”¨äºè®°å½•åˆ†çº¢ã€å·²å®ç°ç›ˆäºç­‰ã€‚æ­£æ•°å¢åŠ ç›ˆäºï¼Œè´Ÿæ•°å‡å°‘ã€‚</div>
            </div>
            <button onclick="submitEdit()" class="btn-primary" style="width: 100%;">ä¿å­˜ä¿®æ­£</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        let FX = { USD: 7.25, HKD: 0.93, CNY: 1.00 };
        let currentCategory = 'all';
        let portfolioData = {};
        let isFirstLoad = true;
        let forceRenderFull = false;
        const syms = { USD: '$', HKD: 'HK$', CNY: 'Â¥' };

        // ä¾› base.html è°ƒç”¨çš„æ›´æ–°å‡½æ•°
        function updatePageData() {
            if (Object.keys(portfolioData).length > 0) {
                renderFullTable(portfolioData);
                // é‡æ–°è®¡ç®—å¹¶æ˜¾ç¤ºé¡¶éƒ¨ç»Ÿè®¡æ•°æ®
                let tMV = 0, tCost = 0, tDay = 0, gFloat = 0, gTotal = 0;
                for (let code in portfolioData) {
                    const d = portfolioData[code];
                    // éœ€è¦ä½¿ç”¨åŸå§‹æ•°æ®é‡æ–°èšåˆï¼Œä½† portfolioData å·²ç»æ˜¯è®¡ç®—åçš„äº†
                    // å¹¸å¥½ refreshAll ä¼šé‡æ–°ä¿å­˜æ•°æ®
                }
                // æœ€ç®€å•çš„æ–¹å¼æ˜¯é‡æ–°åˆ·æ–°æ•´ä¸ªé¡µé¢æ•°æ®
                refreshAll();
            }
        }

        // ç»˜åˆ¶èƒŒæ™¯è¶‹åŠ¿å›¾
        function drawMiniChart(canvasId, change) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const parent = canvas.parentElement;
            const width = canvas.width = parent.offsetWidth;
            const height = canvas.height = 60;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, width, height);

            // ç”Ÿæˆç¬¦åˆè¶‹åŠ¿çš„æ¨¡æ‹Ÿæ•°æ®
            const points = [];
            const pointCount = 50;
            const baseValue = 100;
            const isUp = change >= 0;
            const trendStrength = Math.min(Math.abs(change) / 2, 5);

            for (let i = 0; i < pointCount; i++) {
                const progress = i / (pointCount - 1);
                let value = baseValue;
                
                // åŸºç¡€è¶‹åŠ¿
                if (isUp) {
                    value += progress * trendStrength * 10;
                } else {
                    value -= progress * trendStrength * 10;
                }
                
                // éšæœºæ³¢åŠ¨
                value += (Math.random() - 0.5) * 5;
                
                // ç¡®ä¿æœ€åä¸€ç‚¹åæ˜ æ¶¨è·Œ
                if (i === pointCount - 1) {
                    if (isUp && value < baseValue) value = baseValue + 5;
                    if (!isUp && value > baseValue) value = baseValue - 5;
                }
                
                points.push(value);
            }

            const min = Math.min(...points);
            const max = Math.max(...points);
            const range = max - min;

            // ç»˜åˆ¶æ¸å˜å¡«å……
            const color = isUp ? '#ef4444' : '#10b981';
            
            ctx.beginPath();
            ctx.moveTo(0, height);
            points.forEach((point, i) => {
                const x = (i / (points.length - 1)) * width;
                const y = height - ((point - min) / range) * height * 0.85 - height * 0.05;
                ctx.lineTo(x, y);
            });
            ctx.lineTo(width, height);
            ctx.closePath();

            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, color + '40');
            gradient.addColorStop(1, color + '05');
            ctx.fillStyle = gradient;
            ctx.fill();

            // ç»˜åˆ¶çº¿æ¡
            ctx.beginPath();
            points.forEach((point, i) => {
                const x = (i / (points.length - 1)) * width;
                const y = height - ((point - min) / range) * height * 0.85 - height * 0.05;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        async function refreshAll() {
            const timestamp = Date.now();

            try { FX = await (await fetch(`/api/rates?t=${timestamp}`)).json(); } catch(e) {}

            const idxs = ['s_sh000001', 'rt_hkHSTECH', 'gb_ixic'];
            try {
                const idxPrices = await (await fetch(`/api/prices/batch?t=${timestamp}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({codes: idxs})
                })).json();
                
                const idxMap = {
                    's_sh000001': { id: 'sh000001', name: 'ä¸Šè¯æŒ‡æ•°' },
                    'rt_hkHSTECH': { id: 'hstech', name: 'æ’ç”Ÿç§‘æŠ€' },
                    'gb_ixic': { id: 'nasdaq', name: 'çº³æ–¯è¾¾å…‹' }
                };
                
                for (let code in idxPrices) {
                    const data = idxPrices[code];
                    const info = idxMap[code];
                    const el = document.getElementById(`val-${info.id}`);
                    const chgEl = document.getElementById(`chg-${info.id}`);
                    
                    if (el && data) {
                        const val = data.price > 0 ? data.price : data.yclose;
                        if (val > 0) {
                            el.innerText = val.toFixed(2);
                            const color = data.chg >= 0 ? 'up' : 'down';
                            chgEl.className = `idx-change ${color}`;
                            chgEl.innerText = `${data.chg >= 0 ? '+' : ''}${data.chg.toFixed(2)}%`;
                            drawMiniChart(`chart-${info.id}`, data.chg);
                        }
                    }
                }
            } catch (e) { }

            try {
                const apiUrl = currentCategory === 'all' ? '/api/portfolio' : `/api/portfolio?type=${currentCategory}`;
                const cacheBreaker = `t=${timestamp}_${Math.random().toString(36).substring(7)}`;
                const separator = apiUrl.includes('?') ? '&' : '?';
                const fullUrl = `${apiUrl}${separator}${cacheBreaker}`;
                console.log('%c=== è¯·æ±‚æŒä»“æ•°æ® ===', 'font-weight: bold; color: #e91e63;');
                console.log('currentCategory:', currentCategory);
                console.log('apiUrl:', apiUrl);
                console.log('cacheBreaker:', cacheBreaker);
                console.log('separator:', separator);
                console.log('fullUrl:', fullUrl);
                const data = await (await fetch(fullUrl)).json();
                console.log('%cæŒä»“æ•°æ®è¿”å›:', 'font-weight: bold; color: #4caf50;', data.length, 'æ¡');
                console.log('æŒä»“æ•°æ®:', data);

                const prices = await (await fetch('/api/prices/batch?t=' + timestamp, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({codes: data.map(s => s.code)})
                })).json();

                const newData = {};
                const newCodes = new Set();
                let tMV = 0, tCost = 0, tDay = 0, gFloat = 0, gTotal = 0;
                
                for (let s of data) {
                    const d = prices[s.code] || {price: 0, yclose: 0, chg: 0};
                    const qty = parseFloat(s.qty);
                    const cost = parseFloat(s.price);
                    const adj = parseFloat(s.adjustment) || 0;
                    
                    let curPrice = d.price > 0 ? d.price : (d.yclose > 0 ? d.yclose : cost);
                    const mv = curPrice * qty;
                    const ycloseRef = d.yclose || cost;
                    const day = (curPrice - ycloseRef) * qty;
                    const dayPnlRate = ycloseRef > 0 && d.chg === 0 ? ((curPrice - ycloseRef) / ycloseRef * 100) : (d.chg || 0);
                    const totPnl = (curPrice - cost) * qty + adj;
                    const rate = FX[s.curr] || 1;
                    const totPnlRate = cost * qty > 0 ? (totPnl / (cost * qty) * 100) : 0;

                    tMV += mv * rate;
                    tCost += cost * qty * rate;
                    tDay += day * rate;
                    gFloat += (mv - cost * qty) * rate;
                    gTotal += totPnl * rate;

                    newData[s.code] = {
                        s, d, qty, cost, adj, curPrice, mv, day,
                        dayPnlRate, totPnl, totPnlRate, rate
                    };
                    newCodes.add(s.code);
                }

                const oldCodes = new Set(Object.keys(portfolioData));
                const codesChanged = new Set([...newCodes].filter(c => !oldCodes.has(c)));
                const codesRemoved = new Set([...oldCodes].filter(c => !newCodes.has(c)));

                if (isFirstLoad || forceRenderFull || codesChanged.size > 0 || codesRemoved.size > 0) {
                    renderFullTable(newData);
                } else {
                    updateTableValues(newData);
                }

                portfolioData = newData;
                isFirstLoad = false;
                forceRenderFull = false;

                document.getElementById('totalMV').innerText = isPrivacyMode ? '****' : `Â¥ ${tMV.toLocaleString('zh-CN', {maximumFractionDigits: 0})}`;
                
                const updateStat = (id, val, base) => {
                    const el = document.getElementById(id);
                    const rateEl = document.getElementById(id.replace('Pnl', 'Rate'));
                    el.innerText = isPrivacyMode ? '****' : `Â¥ ${val.toLocaleString('zh-CN', {maximumFractionDigits: 0})}`;
                    el.className = 'pnl-value ' + (val >= 0 ? 'up' : 'down');
                    const rate = base > 0 ? (val / base * 100) : 0;
                    rateEl.innerText = `${rate >= 0 ? '+' : ''}${rate.toFixed(2)}%`;
                    rateEl.className = 'pnl-rate ' + (rate >= 0 ? 'up' : 'down');
                };
                
                updateStat('todayPnl', tDay, tMV - tDay);
                updateStat('floatPnl', gFloat, tCost);
                updateStat('totalPnl', gTotal, tCost);

            } catch (err) {
                console.error('Portfolio error:', err);
            }
        }

        function renderFullTable(dataMap) {
            const body = document.getElementById('assetBody');
            body.innerHTML = '';
            
            for (let code in dataMap) {
                const {s, qty, cost, curPrice, mv, day, dayPnlRate, totPnl, totPnlRate} = dataMap[code];
                const prec = (s.code.startsWith('f_') || s.code.startsWith('ft_')) ? 4 : 3;
                const displayCode = formatDisplayCode(s.code);
                const dayPnlClass = day >= 0 ? 'up' : 'down';
                const totPnlClass = totPnl >= 0 ? 'up' : 'down';

                const priceCell = 
                    `<div class="price-cell">
                        <span class="price-value">${syms[s.curr] || ''}${cost.toFixed(prec)}</span>
                        <span class="price-value" style="font-size: 13px; color: var(--text-secondary);">${syms[s.curr] || ''}${curPrice.toFixed(prec)}</span>
                    </div>`;
                
                const dayPnlCell = 
                    `<div class="pnl-cell ${dayPnlClass}">
                        <span class="pnl-value">${isPrivacyMode ? '****' : (syms[s.curr] || '') + day.toFixed(2)}</span>
                        <span class="pnl-rate">${dayPnlRate >= 0 ? '+' : ''}${dayPnlRate.toFixed(2)}%</span>
                    </div>`;
                
                const totPnlCell = 
                    `<div class="pnl-cell ${totPnlClass}">
                        <span class="pnl-value">${isPrivacyMode ? '****' : (syms[s.curr] || '') + totPnl.toFixed(2)}</span>
                        <span class="pnl-rate">${totPnlRate >= 0 ? '+' : ''}${totPnlRate.toFixed(2)}%</span>
                    </div>`;

                const tr = document.createElement('tr');
                tr.id = `row-${s.code}`;
                tr.innerHTML = `
                    <td class="code-cell">${displayCode}</td>
                    <td class="name-cell" title="${s.name}">${s.name}</td>
                    <td>${isPrivacyMode ? '****' : qty.toLocaleString()}</td>
                    <td>${priceCell}</td>
                    <td>${isPrivacyMode ? '****' : (syms[s.curr] || '') + mv.toFixed(2)}</td>
                    <td>${dayPnlCell}</td>
                    <td>${totPnlCell}</td>
                    <td style="text-align: right; overflow: visible;">
                        <div class="dropdown">
                            <button class="more-btn" onclick="toggleDropdown('${s.code}')" title="æ›´å¤šæ“ä½œ">â‹®</button>
                            <div id="dropdown-${s.code}" class="dropdown-content">
                                <button onclick="openTradeModal('buy','${s.code}','${s.name}','${curPrice}')">â• åŠ ä»“</button>
                                <button onclick="openTradeModal('sell','${s.code}','${s.name}','${curPrice}')">â– å‡ä»“</button>
                                <div style="height: 1px; background: var(--border); margin: 2px 0;"></div>
                                <button onclick="openEditModal('${s.code}','${s.name}',${qty},${cost},${s.adjustment})">ğŸ“ ä¿®æ­£æŒä»“</button>
                                <div style="height: 1px; background: var(--border); margin: 2px 0;"></div>
                                <button class="delete-btn" onclick="deleteStock('${s.code}')">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                        </div>
                    </td>`;
                body.appendChild(tr);
            }
        }

        function updateTableValues(newDataMap) {
            for (let code in newDataMap) {
                const {s, qty, cost, curPrice, mv, day, dayPnlRate, totPnl, totPnlRate} = newDataMap[code];
                const tr = document.getElementById(`row-${code}`);
                if (!tr) continue;

                const prec = (s.code.startsWith('f_') || s.code.startsWith('ft_')) ? 4 : 3;
                const dayPnlClass = day >= 0 ? 'up' : 'down';
                const totPnlClass = totPnl >= 0 ? 'up' : 'down';

                const cells = tr.querySelectorAll('td');
                
                // æŒæœ‰æ•°é‡
                cells[2].innerText = isPrivacyMode ? '****' : qty.toLocaleString();

                // ä»·æ ¼ (å§‹ç»ˆæ˜¾ç¤º)
                cells[3].innerHTML = `<div class="price-cell">
                    <span class="price-value">${syms[s.curr] || ''}${cost.toFixed(prec)}</span>
                    <span class="price-value" style="font-size: 13px; color: var(--text-secondary);">${syms[s.curr] || ''}${curPrice.toFixed(prec)}</span>
                </div>`;
                
                // å¸‚å€¼
                cells[4].innerText = isPrivacyMode ? '****' : `${syms[s.curr] || ''}${mv.toFixed(2)}`;

                // å½“æ—¥ç›ˆäº (éšè—é‡‘é¢ï¼Œä¿ç•™ç™¾åˆ†æ¯”)
                cells[5].innerHTML = `<div class="pnl-cell ${dayPnlClass}">
                    <span class="pnl-value">${isPrivacyMode ? '****' : (syms[s.curr] || '') + day.toFixed(2)}</span>
                    <span class="pnl-rate">${dayPnlRate >= 0 ? '+' : ''}${dayPnlRate.toFixed(2)}%</span>
                </div>`;

                // ç´¯è®¡ç›ˆäº (éšè—é‡‘é¢ï¼Œä¿ç•™ç™¾åˆ†æ¯”)
                cells[6].innerHTML = `<div class="pnl-cell ${totPnlClass}">
                    <span class="pnl-value">${isPrivacyMode ? '****' : (syms[s.curr] || '') + totPnl.toFixed(2)}</span>
                    <span class="pnl-rate">${totPnlRate >= 0 ? '+' : ''}${totPnlRate.toFixed(2)}%</span>
                </div>`;
                
                cells[7].style.overflow = 'visible';
                cells[7].innerHTML = `
                    <div class="dropdown">
                        <button class="more-btn" onclick="toggleDropdown('${s.code}')" title="æ›´å¤šæ“ä½œ">â‹®</button>
                        <div id="dropdown-${s.code}" class="dropdown-content">
                            <button onclick="openTradeModal('buy','${s.code}','${s.name}','${curPrice}')">â• åŠ ä»“</button>
                            <button onclick="openTradeModal('sell','${s.code}','${s.name}','${curPrice}')">â– å‡ä»“</button>
                            <div style="height: 1px; background: var(--border); margin: 2px 0;"></div>
                            <button onclick="openEditModal('${s.code}','${s.name}',${qty},${cost},${s.adjustment})">ğŸ“ ä¿®æ­£æŒä»“</button>
                            <div style="height: 1px; background: var(--border); margin: 2px 0;"></div>
                            <button class="delete-btn" onclick="deleteStock('${s.code}')">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>`;
            }
        }

        async function edit(el, field, code) {
            // ... (å¦‚æœä¸å†ä½¿ç”¨å¯ä»¥ç§»é™¤ï¼Œä½†ä¿ç•™ä¹Ÿæ²¡äº‹)
        }

        function openModal(type) { 
            document.getElementById('overlay').style.display = 'block'; 
            document.getElementById('addForm').style.display = 'block'; 
            document.getElementById('tradeForm').style.display = 'none'; 
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('modalTitle').innerText = 'æ·»åŠ èµ„äº§'; 
            document.getElementById('mCode').value = ''; 
            document.getElementById('mPrice').value = ''; 
            document.getElementById('mQty').value = ''; 
            document.getElementById('suggest').style.display = 'none'; 
        }
        
        function openTradeModal(type, c, n, p) { 
            document.getElementById('overlay').style.display = 'block'; 
            document.getElementById('addForm').style.display = 'none'; 
            document.getElementById('tradeForm').style.display = 'block'; 
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('modalTitle').innerText = type === 'buy' ? 'åŠ ä»“' : 'å‡ä»“';
            document.getElementById('tCode').value = c; 
            document.getElementById('tNameDisplay').innerText = `${n} ${type === 'buy' ? 'åŠ ä»“' : 'å‡ä»“'}`; 
            document.getElementById('tPrice').value = p; 
            document.getElementById('tQty').value = ''; 
            const btn = document.getElementById('tradeSubmitBtn'); 
            btn.innerText = type === 'buy' ? 'ç¡®è®¤åŠ ä»“' : 'ç¡®è®¤å–å‡º'; 
            btn.style.background = type === 'buy' ? 'var(--red)' : 'var(--green)';
            btn.onclick = () => confirmTrade(type); 
        }
        
        async function saveAsset() {
            const realCode = document.getElementById('mRealCode').value.trim();
            const savedCurrency = document.getElementById('mCurrency').value.trim();
            const savedName = document.getElementById('mName').value.trim();
            let code = document.getElementById('mCode').value.trim();
            const price = document.getElementById('mPrice').value;
            const qty = document.getElementById('mQty').value;
            
            // å¦‚æœæœ‰ä»æœç´¢ç»“æœé€‰ä¸­çš„ä»£ç ï¼Œç›´æ¥ä½¿ç”¨
            if (realCode) {
                code = realCode;
            } else {
                // å¦åˆ™è§£ææ‰‹åŠ¨è¾“å…¥çš„ä»£ç 
                if (/^\d+$/.test(code)) {
                    if (code.startsWith('11')) code = 'f_' + code;
                    else if (code.startsWith('6') || code.startsWith('5') || code.startsWith('9')) code = 'sh' + code;
                    else if (code.startsWith('0') || code.startsWith('3') || code.startsWith('1') || code.startsWith('2')) code = 'sz' + code;
                    else if (code.startsWith('4') || code.startsWith('8')) code = 'bj' + code;
                } else if (code.toUpperCase().endsWith('.HK')) {
                    // æ¸¯è‚¡ä¿æŒ.HKæ ¼å¼
                    code = code.toUpperCase();
                } else if (/^[a-zA-Z]+$/.test(code)) {
                    code = 'gb_' + code.toLowerCase();
                }
            }

            // ä½¿ç”¨ä¿å­˜çš„è´§å¸ï¼Œæˆ–æ ¹æ®ä»£ç æ¨æ–­
            let curr = savedCurrency || 'CNY';
            if (!savedCurrency) {
                if (code.startsWith('gb_') || code.startsWith('ft_')) curr = 'USD';
                else if (code.toUpperCase().endsWith('.HK')) curr = 'HKD';
            }
            
            // ä½¿ç”¨ä¿å­˜çš„åç§°ï¼Œæˆ–ä½¿ç”¨ä»£ç 
            const name = savedName || code;
            
            await fetch(`/api/portfolio/add?t=${Date.now()}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code, name: code, qty, price, curr, adjustment: 0})
            });
            document.getElementById('overlay').style.display = 'none';
            // æ¸…ç©ºéšè—å­—æ®µ
            document.getElementById('mRealCode').value = '';
            document.getElementById('mCurrency').value = '';
            document.getElementById('mName').value = '';
            refreshAll();
        }

        async function confirmTrade(type) { 
            const code = document.getElementById('tCode').value;
            const price = document.getElementById('tPrice').value;
            const qty = document.getElementById('tQty').value;
            await fetch(`/api/portfolio/${type}?t=${Date.now()}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code, price, qty})
            }); 
            document.getElementById('overlay').style.display = 'none'; 
            refreshAll(); 
        }
        
        async function deleteStock(code) { 
            if (confirm("ç¡®å®šåˆ é™¤æ­¤èµ„äº§ï¼Ÿ")) {
                await fetch(`/api/portfolio/delete?t=${Date.now()}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code})
                }); 
                refreshAll(); 
            } 
        }

        // ä¿®æ­£æŒä»“å¼¹çª—
        function openEditModal(code, name, qty, cost, adj) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('tradeForm').style.display = 'none';
            document.getElementById('editForm').style.display = 'block';
            
            document.getElementById('modalTitle').innerText = 'ä¿®æ­£æŒä»“';
            document.getElementById('eCode').value = code;
            document.getElementById('eNameDisplay').innerText = `${name} (${formatDisplayCode(code)})`;
            document.getElementById('eQty').value = qty;
            document.getElementById('ePrice').value = cost;
            document.getElementById('eAdj').value = adj;
        }

        // æäº¤ä¿®æ­£
        async function submitEdit() {
            const code = document.getElementById('eCode').value;
            const qty = document.getElementById('eQty').value;
            const price = document.getElementById('ePrice').value;
            const adjustment = document.getElementById('eAdj').value || 0;
            
            await fetch(`/api/portfolio/modify?t=${Date.now()}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code, qty, price, adjustment})
            });
            document.getElementById('overlay').style.display = 'none';
            refreshAll();
        }

        // ä¸‹æ‹‰èœå•æ§åˆ¶
        function toggleDropdown(code) {
            const dropdown = document.getElementById(`dropdown-${code}`);
            // å…³é—­å…¶ä»–æ‰€æœ‰èœå•
            const dropdowns = document.getElementsByClassName("dropdown-content");
            for (let i = 0; i < dropdowns.length; i++) {
                if (dropdowns[i].id !== `dropdown-${code}`) {
                    dropdowns[i].classList.remove('show');
                }
            }
            dropdown.classList.toggle("show");
            
            // é˜»æ­¢å†’æ³¡
            event.stopPropagation();
        }

        // ç‚¹å‡»çª—å£å…¶ä»–åœ°æ–¹å…³é—­èœå•
        window.onclick = function(event) {
            if (!event.target.matches('.more-btn')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }
        
        let searchTimeout;
        document.getElementById('mCode').addEventListener('input', (e) => { 
            clearTimeout(searchTimeout);
            const v = e.target.value.trim(); 
            const box = document.getElementById('suggest'); 
            if (v.length < 1) { 
                box.style.display = 'none'; 
                return; 
            }
            searchTimeout = setTimeout(async () => {
                const r = await fetch(`/api/search?q=${encodeURIComponent(v)}&t=${Date.now()}`);
                const list = await r.json(); 
                if (list.length > 0) {
                    box.innerHTML = list.map(s => {
                        let typeIcon = 'â“';
                        let typeColor = '#666';
                        const code = s.code.toLowerCase();
                        let displayCode = s.code;

                        if (code.startsWith('sh') || code.startsWith('sz') || code.startsWith('bj')) {
                            typeIcon = 'ğŸ‡¨ğŸ‡³ Aè‚¡';
                            typeColor = '#3b82f6';
                            displayCode = s.code.replace(/^(sh|sz|bj)/i, '');
                        } else if (code.endsWith('.hk')) {
                            typeIcon = 'ğŸ‡­ğŸ‡° æ¸¯è‚¡';
                            typeColor = '#f59e0b';
                            displayCode = s.code.toUpperCase();
                        } else if (code.startsWith('gb_')) {
                            typeIcon = 'ğŸ‡ºğŸ‡¸ ç¾è‚¡';
                            typeColor = '#8b5cf6';
                            displayCode = s.code.replace(/^gb_/i, '').toUpperCase();
                        } else if (code.startsWith('f_') || code.startsWith('ft_')) {
                            typeIcon = 'ğŸ“Š åŸºé‡‘';
                            typeColor = '#10b981';
                            displayCode = s.code.replace(/^f_/i, '');
                        }

                        return `<div class="suggest-item" onclick="pick('${s.code}','${s.name}','${s.currency}')">
                            <span class="suggest-name">${s.name}</span>
                            <div class="suggest-info">
                                <span class="tag" style="background: ${typeColor}20; color: ${typeColor};">${typeIcon}</span>
                                <span class="suggest-code">${displayCode}</span>
                            </div>
                        </div>`;
                    }).join('');
                    box.style.display = 'block';
                } else {
                    box.style.display = 'none';
                }
            }, 300);
        });

        function pick(c, n, cur) {
            document.getElementById('mCode').value = n;
            document.getElementById('mRealCode').value = c;
            document.getElementById('mCurrency').value = cur;
            document.getElementById('mName').value = n;
            document.getElementById('suggest').style.display = 'none';
        }
        
        // saveAsImage å·²åœ¨ base.html ä¸­å®šä¹‰

        function switchCategory(type) {
            console.log('%c========== åˆ‡æ¢åˆ†ç±» ==========', 'font-weight: bold; color: #e91e63;');
            console.log('åˆ‡æ¢åˆ°:', type);
            console.log('åˆ‡æ¢å‰ currentCategory:', currentCategory);
            console.log('åˆ‡æ¢å‰ portfolioData keys:', Object.keys(portfolioData));
            currentCategory = type;
            console.log('åˆ‡æ¢å currentCategory:', currentCategory);

            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.type === type) {
                    tab.classList.add('active');
                }
            });

            portfolioData = {};
            forceRenderFull = true;
            console.log('å·²æ¸…ç©ºportfolioDataå¹¶è®¾ç½®forceRenderFull=trueï¼Œå‡†å¤‡è°ƒç”¨refreshAll...');
            refreshAll();
        }

        setInterval(refreshAll, 60000);

        window.onload = () => {
            refreshAll();
        };

        // æ·»åŠ å…¨å±€ç¼“å­˜ç ´åå‡½æ•°
         function fetchWithCache(url, options = {}) {
            if (!url.includes('?')) {
                url += '?';
            } else {
                url += '&';
            }
            url += `t=${Date.now()}`;
            return fetch(url, options);
        }
        
        function forceReload() {
            window.location.reload(true);
        }
    </script>
{% endblock %}
