# 更新日志 (Changelog)

## [v13.0.0] - 2025-01-20

### 🎉 重大更新

#### 多币种显示系统
- ✨ 新增自动识别市场类型（A股/港股/美股/基金）
- ✨ 实现币种符号自动显示（¥/HK$/$/）
- ✨ 投资汇总自动换算为人民币
- ✨ 实时汇率获取（USD、HKD）
- 🔧 优化周末休市判断逻辑

#### 数据加载与缓存优化
- ✨ 新增 `data_manager.py` 数据管理模块
- ✨ 实现全局数据预加载机制
- ✨ 支持每30秒自动刷新
- 🔧 分析页优先显示缓存数据，后台静默刷新
- 🔧 优化投资页加载流程，去掉loading遮罩

#### 关键Bug修复
- 🐛 **修复资产详情页loading卡顿问题**（几乎必现）
  - 改进 `safe_update()` 更新优先级
  - 新增数据类型验证
  - 添加300ms延迟防止导航冲突
- 🐛 **修复添加资产后自动跳转首页问题**（几乎必现）
- 🐛 **修复分析页切换时数据为空问题**
- 🐛 **修复今日盈亏周末显示异常**

### 🎨 UI/UX 优化

#### 登录页面
- 🎨 统一输入框和按钮高度（56px）
- 🎨 验证码输入框动态启用登录按钮
- 🎨 优化邮箱验证逻辑

#### 首页
- 🎨 卡片向上移动（顶部间距减少）
- 🎨 "记一笔"按钮居中显示
- 🎨 优化添加资产弹窗
  - 标签更新："负债" → "我的负债"
  - 标签更新："名称" → "资产名称"
  - 移除取消按钮
  - 新增右上角X关闭按钮

#### 投资页面
- 🎨 持仓列表改为左对齐（符合主流APP设计）
- 🎨 优化列宽度（80/70/70）
- 🎨 去掉数量单位"股"
- 🎨 实时显示对应币种符号

#### 快讯页面
- 🎨 时间移至卡片左下角内部
- 🎨 减少标题间距

#### 分析页面
- 🎨 优先显示缓存数据（无闪烁）
- 🎨 后台静默刷新

### 🔧 技术改进

#### 新增模块
- `data_manager.py` - 统一数据管理
  - 预加载所有数据
  - 自动刷新机制
  - 缓存优化

#### API增强
- `api.py`
  - 新增 `get_exchange_rates_sync()` 实时汇率获取
  - 优化错误处理和默认汇率

#### 状态管理
- `state.py`
  - 新增汇率存储 `exchange_rates`
  - 新增 `update_exchange_rates()` 方法
  - 优化 `_calculate_invest_summary()` 支持多币种转换
  - 修复今日盈亏周末判断逻辑

#### 页面优化
- `pages/detail.py`
  - 改进更新机制（page.update优先）
  - 数据类型验证
  - 防止导航冲突延迟
- `pages/invest.py`
  - 币种符号逻辑
  - 布局左对齐
- `pages/analysis.py`
  - 缓存优先策略
  - 静默后台刷新

### 📊 代码统计
- **修改文件**: 13个
- **新增文件**: 1个 (data_manager.py)
- **代码变更**: +1,114 / -313 行
- **问题修复**: 11个

### 🔗 相关链接
- GitHub: https://github.com/konaoo/kona.git
- Commit: c99a7d0

---

## [v12.0.0] - 之前版本
（参考 README.md 中的更新日志）

